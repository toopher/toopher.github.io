---
layout: post
category: 
tags: [oath otp]
author: Drew
display_title: OATH Hardware Tokens and Toopher part 2: The code
---
{% include JB/setup %}

In Part 1, I introduced our OTP Hardware Token support, and showed the
new API endpoints that enable it.  Here I'll talk about some [changes to
the toopher-python library](https://github.com/toopher/toopher-python/tree/feature/oath-otp-validator-support)
that make the new features a bit simpler to use.

Note that to access these features, you need to be on the [oath-otp-validator-support]
(https://github.com/toopher/toopher-python/tree/feature/oath-otp-validator-support)
branch of toopher-python.  These features will probably be merged into
master at some point, but right now you need to be on the bleeding edge.

## Boilerplate

If you are following along in `ipython`, you will need to instantiate a reference
to the Toopher client API:

```
import toopher
api = toopher.ToopherAPI(YOUR_TOOPHER_KEY, YOUR_TOOPHER_SECRET)
```

If you don't have a Toopher key and secret, you can always get one
for free by registering at the [Toopher Developer site](https://dev.toopher.com).

## The OathOtpValidator resource

Each physical hardware OTP generator token is represented in the Toopher API
as an instance of an `OathOtpValidator` resource.  A single `OathOtpValidator` may
be used by multiple requesters, and may be assigned to multiple users.  This feature
is useful in cases where you may have the same userbase that authenticates through
multiple entry points represented by multiple requesters.

### Fields:

*   `id` - The Toopher-assigned UUID for this token
*   `secret` - Hex-encoded OATH secret
*   `requester_specified_id` - Arbitrary string used by requester to reference this particular token later. Typically, this would be the serial number of the token.
*   `otp_type` - One of `hotp` or `totp`.  Default: `totp`
*   `otp_digits` - Length of each OTP
*   `algorithm` - One of `sha1`, `sha256`, or `sha512`.  Default: `sha1`
*   `totp_step_size` - Only relevant if `otp_type` is `totp`.  Default is `30`

### Instance Methods

*   `associate_with_user(user)` - Associate the OATH token with a particular user
*   `dissociate_from_user(user)` - Remove this OATH token from the user's list of tokens
*   `deactivate()` - Remove ALL user associations from this token.  The token will remain in inventory, and any state information (i.e. HOTP event count) is preserved.  It can be re-associated with a user at any time.
*   `resynchronize(otp_sequence)` - Reset the HOTP event counter or TOTP drift tracker to a known state.  `otp_sequence` must be a sequence of **AT LEAST TWO** sequential OTPs generated by the token.

## OathOtpValidators factory object

The `OathOtpValidators` factory is uses to get or create `OathOtpValidator` instances
that represent the physical tokens used by your organization.  It includes facilities
to bulk-provision tokens in the Toopher API from CSV files provided by the token
manufacturers.

### Factory methods

*   `get_by_id(id)` - Retrieve an `OathOtpValidator` resource by the Toopher-specified UUID
*   `get_by_requester_specified_id(requester_specified_id)` - Retrieve an `OathOtpValidator` resource by requester_specified_id (typically a serial number)
*   `provision(self, secret, requester_specified_id=None, otp_type='totp', otp_digits=8, algorithm='sha1', totp_step_size=30, **kwargs):` - Create (provision) and return a new `OathOtpValidator` resource with the specified parameters.
*   `bulk_provision_from_csv(file_or_filename, style)` - Provision multiple tokens using data specified in a CSV file.  The particular CSV format is defined as a dictionary in the `style` parameter; Known CSV formats for various manufacturers are/will be defined as constants in `OathOtpValidators.InputFormat`

## Examples

#### Provisioning a new event-based (HOTP) `OathOtpValidator` with the hex-encoded secret "abcdef0123456789" and serial number "A12345" that generates 6-digit OTPs

```
token = api.advanced.oath_otp_validators.provision('abcdef0123456789', requester_specified_id='A12345', otp_type='hotp', otp_digits=6)
```

#### Get a (previously-provisioned) token with the serial number "A12345", and assign it to a user named "jdoe"

```
token = api.advanced.oath_otp_validators.get_by_requester_specified_id('A12345')
user = api.advanced.users.get_by_name('jdoe')
user.associate_oath_otp_validator(token)
```

#### Get a list of all `OathOtpValidators` associated with the user named "jdoe"

```
user = api.advanced.users.get_by_name('jdoe')
list_of_tokens = user.get_oath_otp_validators()
```

#### Dissociate an existing `OathOtpValidator` that is used by the user named "jdoe" and re-assign it to a user named "jspringer"

```
jdoe_user = api.advanced.users.get_by_name('jdoe')
jdoe_token_list = jdoe_user.get_oath_otp_validators()
token_to_transfer = jdoe_token_list[0]

# remove the token from jdoe's possession
jdoe_user.dissociate_oath_otp_validator(token_to_transfer)

# add it to jspringer's possession
jspringer_user = api.advanced.users.get_by_name('jspringer')
jspringer_user.associate_oath_otp_validator(token_to_transfer)
```
